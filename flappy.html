<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let birdY, velocity;
let gravity = 0.5;
let pipes = [];
let score = 0;
let gameRunning = false;
let pipeSpeed = 2;
let pipeGap = 130;
let animationId;

/* START GAME */
function startGame(){
  cancelAnimationFrame(animationId);   // stop old loop

  // APPLY DIFFICULTY
  const diff = document.getElementById("difficulty").value;

  if(diff === "easy"){
    pipeSpeed = 1.5;
    pipeGap = 170;
  }
  else if(diff === "medium"){
    pipeSpeed = 2.5;
    pipeGap = 130;
  }
  else{
    pipeSpeed = 3.5;
    pipeGap = 100;
  }

  // RESET GAME
  birdY = canvas.height / 2;
  velocity = 0;
  pipes = [];
  score = 0;
  gameRunning = true;

  loop();
}

/* JUMP */
document.addEventListener("keydown", jump);
canvas.addEventListener("click", jump);

function jump(){
  if(!gameRunning) return;
  velocity = -8;
}

/* DRAW BIRD */
function drawBird(){
  ctx.fillStyle = "yellow";
  ctx.beginPath();
  ctx.arc(60, birdY, 12, 0, Math.PI * 2);
  ctx.fill();
}

/* GAME LOOP */
function loop(){
  if(!gameRunning) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  velocity += gravity;
  birdY += velocity;
  drawBird();

  // CREATE PIPES
  if(pipes.length === 0 || pipes[pipes.length - 1].x < 180){
    let top = Math.random() * 150 + 40;
    pipes.push({
      x: canvas.width,
      top: top,
      bottom: top + pipeGap,
      scored: false
    });
  }

  ctx.fillStyle = "green";
  pipes.forEach(p => {
    p.x -= pipeSpeed;

    ctx.fillRect(p.x, 0, 45, p.top);
    ctx.fillRect(p.x, p.bottom, 45, canvas.height);

    if(p.x < 60 && !p.scored){
      score++;
      p.scored = true;
    }

    if(
      60 > p.x && 60 < p.x + 45 &&
      (birdY < p.top || birdY > p.bottom)
    ){
      gameOver();
    }
  });

  pipes = pipes.filter(p => p.x > -50);

  if(birdY < 0 || birdY > canvas.height){
    gameOver();
  }

  ctx.fillStyle = "white";
  ctx.font = "18px Arial";
  ctx.fillText("Score: " + score, 10, 25);

  animationId = requestAnimationFrame(loop);
}

function gameOver(){
  gameRunning = false;
  ctx.fillStyle = "red";
  ctx.font = "28px Arial";
  ctx.fillText("Game Over", 75, canvas.height / 2);
}
</script>
